#cloud-config

# MLflow Server Auto-Setup Script
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° MLflow Tracking Server

package_update: true
package_upgrade: true

packages:
  - python3-pip
  - python3-venv
  - postgresql-client
  - nginx
  - supervisor

write_files:
  # Systemd service Ð´Ð»Ñ MLflow
  - path: /etc/systemd/system/mlflow.service
    content: |
      [Unit]
      Description=MLflow Tracking Server
      After=network.target

      [Service]
      Type=simple
      User=mlflow
      WorkingDirectory=/opt/mlflow
      EnvironmentFile=/opt/mlflow/.env
      ExecStart=/opt/mlflow/venv/bin/mlflow server \
        --backend-store-uri postgresql://$${POSTGRES_USER}:$${POSTGRES_PASSWORD}@$${POSTGRES_HOST}:6432/$${POSTGRES_DB} \
        --default-artifact-root s3://$${S3_BUCKET}/mlflow-artifacts/ \
        --host 0.0.0.0 \
        --port 5000
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
    permissions: '0644'
    owner: root:root

  # Nginx reverse proxy Ð´Ð»Ñ MLflow
  - path: /etc/nginx/sites-available/mlflow
    content: |
      server {
          listen 80;
          server_name _;

          location / {
              proxy_pass http://localhost:5000;
              proxy_set_header Host $${host};
              proxy_set_header X-Real-IP $${remote_addr};
              proxy_set_header X-Forwarded-For $${proxy_add_x_forwarded_for};
              proxy_set_header X-Forwarded-Proto $${scheme};
          }
      }
    permissions: '0644'
    owner: root:root

runcmd:
  # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ mlflow
  - useradd -m -s /bin/bash mlflow || true
  
  # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð°
  - mkdir -p /opt/mlflow
  - chown mlflow:mlflow /opt/mlflow
  
  # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env Ñ„Ð°Ð¹Ð» Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
  - |
    cat > /opt/mlflow/.env << 'EOF'
    POSTGRES_HOST=${postgres_host}
    POSTGRES_DB=${postgres_db}
    POSTGRES_USER=${postgres_user}
    POSTGRES_PASSWORD=${postgres_password}
    S3_BUCKET=${s3_bucket}
    AWS_ACCESS_KEY_ID=${s3_access_key}
    AWS_SECRET_ACCESS_KEY=${s3_secret_key}
    MLFLOW_S3_ENDPOINT_URL=${s3_endpoint}
    EOF
  - chown mlflow:mlflow /opt/mlflow/.env
  - chmod 600 /opt/mlflow/.env
  
  # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ð¸Ñ€Ñ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ
  - sudo -u mlflow python3 -m venv /opt/mlflow/venv
  
  # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ MLflow Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
  - /opt/mlflow/venv/bin/pip install --upgrade pip
  - /opt/mlflow/venv/bin/pip install mlflow[extras] psycopg2-binary boto3
  
  # ÐÐ°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼ Nginx
  - ln -s /etc/nginx/sites-available/mlflow /etc/nginx/sites-enabled/
  - rm -f /etc/nginx/sites-enabled/default
  - nginx -t && systemctl reload nginx
  
  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ MLflow service
  - systemctl daemon-reload
  - systemctl enable mlflow
  - systemctl start mlflow
  
  # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð°Ñ‚ÑƒÑÐ°
  - sleep 10
  - systemctl status mlflow --no-pager

final_message: |
  âœ… MLflow Server successfully installed!
  
  ðŸŒ MLflow UI: http://$(curl -s ifconfig.me):5000
  ðŸ“Š Backend: PostgreSQL
  ðŸ’¾ Artifacts: S3 (${s3_bucket})
  
  Check status: systemctl status mlflow
  View logs: journalctl -u mlflow -f
